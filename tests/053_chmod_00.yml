---

- name: setup_chmod_00
  type: setup
  tmpdirs:
    - name: 053_chmod_00_fs
      varname: config_dir
    - name: 053_chmod_00_fs_mount
      varname: mount_dir
  randnames:
    - test_volume
    - test_rg
    - test_ug
  vars:
    - name: n0
      value: $mount_dir/n0
    - name: n1
      value: $mount_dir/n1
    - name: syndicate_conf
      value: $config_dir/syndicate.conf
    - name: rg_driver
      value: $SYNDICATE_PYTHON_ROOT/syndicate/rg/drivers/disk
    - name: rg_path
      value: $SYNDICATE_RG_ROOT/syndicate-rg
    - name: ug_path
      value: $SYNDICATE_UG_ROOT/syndicatefs

- name: config
  type: sequential
  tasks:
    - name: setup
      command: $SYNDICATE_TOOL --trust_public_key -c "$syndicate_conf" --debug setup "$SYNDICATE_ADMIN" "$SYNDICATE_PRIVKEY_PATH" "$SYNDICATE_MS"

    - name: add test volume
      command: $SYNDICATE_TOOL -c "$syndicate_conf" create_volume name=$test_volume description="test volume" blocksize=4096 email=$SYNDICATE_ADMIN

    - name: create RG
      command: $SYNDICATE_TOOL -c "$syndicate_conf" create_gateway name=$test_rg type=RG volume=$test_volume email=$SYNDICATE_ADMIN private_key=auto port=31111

    - name: update RG
      command: $SYNDICATE_TOOL -c "$syndicate_conf" update_gateway name=$test_rg caps=ALL port=31112 driver=$rg_driver

    - name: create UG
      command: $SYNDICATE_TOOL -c "$syndicate_conf" create_gateway name=$test_ug type=UG volume=$test_volume email=$SYNDICATE_ADMIN private_key=auto port=31111

    - name: update UG
      command: $SYNDICATE_TOOL -c "$syndicate_conf" update_gateway name=$test_ug caps=ALL

- name: daemon UG/RG
  type: daemon
  tasks:
    - name: start RG
      command: $rg_path -c "$syndicate_conf" -d2 -f -u $SYNDICATE_ADMIN -v $test_volume -g $test_rg
      exit: 0

    - name: start UG
      command: $ug_path -c "$syndicate_conf" -d2 -f -u $SYNDICATE_ADMIN -v $test_volume -g $test_ug $mount_dir
      exit: 0

- name: check syndicate is mounted
  type: sequential
  tasks:
    - name: wait for syndicatefs to be mounted
      command: sleep 5s

    - name: test filesystem type
      command: stat -f -L -c %T $mount_dir
      compareout: "fuseblk"

- name: run chmod tests 00
  type: sequential
  tasks:
    - name: T1 - make a file
      command: fstest create ${n0} 0644
      compareout: "0"

    - name: T1 - stat a file
      command: fstest stat ${n0} mode
      compareout: "0644"

    - name: T1 - chmod a file
      command: fstest chmod ${n0} 0111
      compareout: "0"

    - name: T1 - stat a file
      command: fstest stat ${n0} mode
      compareout: "0111"

    - name: T1 - unlink a file
      command: fstest unlink ${n0}
      compareout: "0"

    - name: T2 - make a directory
      command: fstest mkdir ${n0} 0755
      compareout: "0"

    - name: T2 - stat a directory
      command: fstest stat ${n0} mode
      compareout: "0755"

    - name: T2 - chmod a directory
      command: fstest chmod ${n0} 0753
      compareout: "0"

    - name: T2 - stat a directory
      command: fstest stat ${n0} mode
      compareout: "0753"

    - name: T2 - rmdir a directory
      command: fstest rmdir ${n0}
      compareout: "0"

    - name: T3 - create a file
      command: fstest create ${n0} 0644
      compareout: "0"

    - name: T3 - create a symlink
      command: fstest symlink ${n0} ${n1}
      compareout: "0"

    - name: T3 - stat a symlink
      command: fstest stat ${n1} mode
      compareout: "0644"

    - name: T3 - chmod a symlink
      command: fstest chmod ${n1} 0321
      compareout: "0"

    - name: T3 - stat a symlink
      command: fstest stat ${n1} mode
      compareout: "0321"

    - name: T3 - lstat a file
      command: fstest lstat ${n0} mode
      compareout: "0321"

    - name: T3 - unlink a file
      command: fstest unlink ${n0}
      compareout: "0"

    - name: T3 - unlink a symlink
      command: fstest unlink ${n1}
      compareout: "0"

    - name: T4 - create a file
      command: fstest create ${n0} 0644
      compareout: "0"

    - name: T4 - create a symlink
      command: fstest symlink ${n0} ${n1}
      compareout: "0"

    - name: T4 - stat a symlink
      command: fstest stat ${n1} mode
      compareout: "0644"

    - name: T4 - lchmod a symlink
      command: fstest lchmod ${n1} 0321
      exit: 1

    - name: T4 - lstat a symlink
      command: fstest lstat ${n1} mode
      compareout: "0777"

    - name: T4 - lchmod a symlink
      command: fstest lchmod ${n1} 0531
      exit: 1

    - name: T4 - lstat a symlink
      command: fstest lstat ${n1} mode
      compareout: "0777"

    - name: T4 - stat a file
      command: fstest stat ${n0} mode
      compareout: "0644"

    - name: T4 - stat a symlink
      command: fstest stat ${n1} mode
      compareout: "0644"

    - name: T4 - unlink a file
      command: fstest unlink ${n0}
      compareout: "0"

    - name: T4 - unlink a symlink
      command: fstest unlink ${n1}
      compareout: "0"

    - name: T6 - create a file
      command: fstest create ${n0} 0644
      compareout: "0"

    - name: T6 - get ctime from a file
      command: fstest stat ${n0} ctime
      saveout: $config_dir/ctime_t6_1

    - name: T6 - sleep 1sec
      command: sleep 1s

    - name: T6 - chmod a file
      command: fstest chmod ${n0} 0111
      compareout: "0"

    - name: T6 - get ctime from a file
      command: fstest stat ${n0} ctime
      saveout: $config_dir/ctime_t6_2

    - name: T6 - compare ctimes
      command: $tasksf_dir/cmptimestamps.py lt -f $config_dir/ctime_t6_1 $config_dir/ctime_t6_2
      exit: 0

    - name: T6 - unlink a file
      command: fstest unlink ${n0}
      compareout: "0"

    - name: T7 - create a directory
      command: fstest mkdir ${n0} 0755
      compareout: "0"

    - name: T7 - get ctime from a directory
      command: fstest stat ${n0} ctime
      saveout: $config_dir/ctime_t7_1

    - name: T7 - sleep 1sec
      command: sleep 1s

    - name: T7 - chmod a directory
      command: fstest chmod ${n0} 0753
      compareout: "0"

    - name: T7 - get ctime from a directory
      command: fstest stat ${n0} ctime
      saveout: $config_dir/ctime_t7_2

    - name: T7 - compare ctimes
      command: $tasksf_dir/cmptimestamps.py lt -f $config_dir/ctime_t7_1 $config_dir/ctime_t7_2
      exit: 0

    - name: T7 - rmdir a directory
      command: fstest rmdir ${n0}
      compareout: "0"

    - name: T8 - create a symlink from a non-existing file
      command: fstest symlink ${n1} ${n0}
      compareout: "0"

    - name: T8 - get ctime from a symlink
      command: fstest lstat ${n0} ctime
      saveout: $config_dir/ctime_t8_1

    - name: T8 - sleep 1sec
      command: sleep 1s

    - name: T8 - lchmod a symlink
      command: fstest lchmod ${n0} 0321
      exit: 1

    - name: T8 - get ctime from a symlink
      command: fstest lstat ${n0} ctime
      saveout: $config_dir/ctime_t8_2

    - name: T8 - compare ctimes
      command: $tasksf_dir/cmptimestamps.py eq -f $config_dir/ctime_t8_1 $config_dir/ctime_t8_2
      exit: 0

    - name: T8 - unlink a symlink
      command: fstest unlink ${n0}
      compareout: "0"

    # unsuccessful chmod(2) does not update ctime.
    - name: T9 - create a file
      command: fstest create ${n0} 0644
      compareout: "0"

    - name: T9 - get ctime from a file
      command: fstest stat ${n0} ctime
      saveout: $config_dir/ctime_t9_1

    - name: T9 - sleep 1sec
      command: sleep 1s

    - name: T9 - chmod a file
      command: fstest -u 65534 chmod ${n0} 0111
      exit: 1

    - name: T9 - get ctime from a file
      command: fstest stat ${n0} ctime
      saveout: $config_dir/ctime_t9_2

    - name: T9 - compare ctimes
      command: $tasksf_dir/cmptimestamps.py eq -f $config_dir/ctime_t9_1 $config_dir/ctime_t9_2
      exit: 0

    - name: T9 - unlink a file
      command: fstest unlink ${n0}
      compareout: "0"

    - name: T10 - create a directory
      command: fstest mkdir ${n0} 0755
      compareout: "0"

    - name: T10 - get ctime from a directory
      command: fstest stat ${n0} ctime
      saveout: $config_dir/ctime_t10_1

    - name: T10 - sleep 1sec
      command: sleep 1s

    - name: T10 - chmod a directory
      command: fstest -u 65534 chmod ${n0} 0753
      exit: 1

    - name: T10 - get ctime from a directory
      command: fstest stat ${n0} ctime
      saveout: $config_dir/ctime_t10_2

    - name: T10 - compare ctimes
      command: $tasksf_dir/cmptimestamps.py eq -f $config_dir/ctime_t10_1 $config_dir/ctime_t10_2
      exit: 0

    - name: T10 - rmdir a directory
      command: fstest rmdir ${n0}
      compareout: "0"

    - name: T11 - create a symlink from a non-existing file
      command: fstest symlink ${n1} ${n0}
      compareout: "0"

    - name: T11 - get ctime from a symlink
      command: fstest lstat ${n0} ctime
      saveout: $config_dir/ctime_t11_1

    - name: T11 - sleep 1sec
      command: sleep 1s

    - name: T11 - lchmod a symlink
      command: fstest -u 65534 lchmod ${n0} 0321
      exit: 1

    - name: T11 - get ctime from a symlink
      command: fstest lstat ${n0} ctime
      saveout: $config_dir/ctime_t11_2

    - name: T11 - compare ctimes
      command: $tasksf_dir/cmptimestamps.py eq -f $config_dir/ctime_t11_1 $config_dir/ctime_t11_2
      exit: 0

    - name: T11 - unlink a symlink
      command: fstest unlink ${n0}
      compareout: "0"
